# 実験手順

NoSEを使用して実験を行うための手順をメモする。

1. `bundle exec nose search rubis --format json`でindexやplanを作成する。formatはjson形式を指定。
2. DB側の準備で`TestNoSE/up_nose_rubis.sh`を実行する
3. `bundle exec nose create $SCHEMA`でDBにスキーマを適用する

## secondary indexの効果を確認する

### 手順

* secondary indexが効きそうなworkloadで、nose searchしてschemaを生成する。そのまま普通の手順でbenchmarkまで行う(benchmarkはまだ一度も試していないのでどう動くか確証がない)。
* 上の方法のschemaからsecondary indexで代用できるものを排除したスキーマでcreate,loadまで行う。そして、手でcreate indexしてsecondary indexを用意した上でbenchmarkを行う。

### もろもろ

* secondary indexを使用しないパターンのbenchmarkの測定まで終わったので、次にスキーマからsecondary indexに置き換えられるものを除いてcassandraのインスタンスを再起動する
    * `search rubis --format json`の結果は見づらいので`search rubis`でsecondary indexに置き換えられるものを識別して判断
* なんとなく、benchmarkによるクエリの実行はsecondary indexがあればcassandra側がいい感じに使ってくれるような気がしてたが、実行planを読み込んでいる以上そんなはずはない。ただ、planの中のクエリを行うindeloop upの後ろの名前をsecondary indexのものに置き換えられれば大丈夫なはず。
* indexを作成したコードは以下の通り
    * `Index lookup i3072603312 [users.password] [users.id] → [users.nickname] $86000 Graph(nodes: users, edges: {}) * 1.0/1`
        * `create index i3072603312 on users(password);`
    * `  Index lookup i801216542 [users.lastname] [users.id] → [users.nickname, users.password] $100000 Graph(nodes: users, edges: {}) * 1.0/1`
        * `create index i801216542 on users(lastname)`
* indexの後ろについてるgraphとかはひとまず何も対策しないが大丈夫だろうか。$の後の数字も.
* createはてっきりindex節の中のindexをcassandra上に構築しておしまいかと思っていたが、createの中でplanの評価をしているみたいでindexesの中からsecondary indexに置き換える対象のindexを削除するだけでは、planを評価した時にnullで落ちてしまう。
* **入力されたindexからある程度よしなにsecondary indexにするものを選択して、secondary indexにするものを作成したが、secondary indexを介してinsertする方法がない。(secondary index)を使用するものと比較するには、中のレコードは一致させておきたい**
    * column familyを定義する時にwhereと関係なく、全てのレコードをカラム分持ってきていたとしたら、secondary indexの分のレコードの挿入はしないことにして、容量が削減できましたでも良さそう
* 現状ではsecondary indexかindexかを識別する手段がない。現在cassandra.rbの中でしているsecondary indexにするか。

# debugログ

## createのデバッグ

* => searchのoptionsでformatで「indexes_txt」と入力したら、「Expected '--format' to be one of txt, json, yml, html; got indexes_txt」と出たので、rubyの形で出力する機能はなさそう。従って探すならcreate側
* => createで読み込んでいるのはschemaディレクトリの下のファイル
* => schema.rbでload内で拡張子を.rbで決め打ちでfile取得しようとしているが、ここが、".rb"のみになっていたからjsonファイルは読み込めていなかった。
* => rubis_json.jsonで実行すれば、nose_cli.rb155行目でschema.modelがデバッガで確認すると@modelではなく、modelとなっているため、参照出来なくて落ちる(rubis_baseline.rbはここでは@modelとなっていて落ちない)
* =>上記のmodeどうこうの箇所はNoSEがplanファイルを存在するか確認するところで、拡張子なしでFile.exist?して確認していたので、呼び出されていた。nose searchの結果にはplanも含まれているため、ここがtrueになるように拡張子を付けてif文の中が実行されるようにした。(ここは、rubis_baselineを入れて見ても拡張子がないため、必ずfalseになっていた。拡張子がないとFile.exists?が必ずfalseになるのはirbで確認済み。ここの箇所はバグではなく何か意図が合ったのか？)
* 「index.newを呼び出す所の引数の数が一致しない」というエラーが出ていて、index.initializeの引数の最後が「saved_key: null」となっていたのを「saved_key = null」と置き換えたらひとまず最後まで走るようになった。

上記の手順でcreateは行えるようになった。

## loadのデバッグ

* いくつかのindexは作成できているのが、「get': Invalid null value for partition key part categories_dummy (Cassandra::Errors::InvalidError)」と出て落ちてしまう。
    * -> mysql側で`update categories set dummy = '1'`として、再実行
    * regions.dummyでも発生したので`update regions set dummy = '1'`を実行
* NoSEは上手く動いていたっぽいが、「Lost connection to MySQL server during query (Mysql2::Error)」が出た。


